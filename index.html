<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Timetable ‚Äî Multi-College</title>
  <style>
    :root{
      /* Default theme (Modern) */
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#4f46e5;
      --accent-2:#10b981;
      --accent-3:#ef4444;
      --panel:#0b1320;
      --glass: rgba(255,255,255,0.03);
      --slot-border: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02);
      --shadow: 0 6px 20px rgba(4,8,20,0.6);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    /* TAFE NSW Theme - Official Colors */
    body.theme-tafe {
      --bg: #1a1a1a;
      --card: #2d2d2d;
      --muted: #b0b0b0;
      --accent: #0052a3;
      --accent-2: #1b7a7e;
      --accent-3: #a6007e;
      --panel: #252525;
      --glass: rgba(0,82,163,0.08);
      --slot-border: rgba(0,82,163,0.12);
      --shadow: 0 6px 20px rgba(0,82,163,0.2);
    }

    /* Sunday Picnic Theme */
    body.theme-picnic {
      --bg: #f5f1ed;
      --card: #ede8e3;
      --muted: #8b7355;
      --accent: #d4845c;
      --accent-2: #6b8e23;
      --accent-3: #c85a54;
      --panel: #f9f6f2;
      --glass: rgba(212,132,92,0.08);
      --slot-border: rgba(212,132,92,0.12);
      --shadow: 0 6px 20px rgba(107,142,35,0.15);
    }

    /* Ocean Breeze Theme */
    body.theme-ocean {
      --bg: #e8f4f8;
      --card: #d4e8f0;
      --muted: #5a7a8a;
      --accent: #1f7bbf;
      --accent-2: #2ce5b7;
      --accent-3: #0dffc4;
      --panel: #e0ecf2;
      --glass: rgba(31,123,191,0.08);
      --slot-border: rgba(31,123,191,0.12);
      --shadow: 0 6px 20px rgba(31,123,191,0.15);
    }

    html,body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg, var(--bg) 0%, var(--card) 60%);
      color: var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background 0.3s ease;
    }

    /* Header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 20px;
      gap:12px;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom: 1px solid var(--slot-border);
      position:sticky;
      top:0;
      z-index:30;
      flex-wrap: wrap;
      transition: all 0.3s ease;
    }
    .left-actions, .right-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      background:transparent;
      border:1px solid var(--slot-border);
      color: var(--muted);
      padding:9px 12px;
      border-radius:8px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition: all 0.2s;
    }
    .btn:hover{
      background: var(--glass);
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn.primary{
      background: linear-gradient(90deg, var(--accent), rgba(255,255,255,0.1));
      color:white;
      border: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:600;
      color: var(--accent);
      font-size:16px;
    }
    .brand .logo{
      width:36px; height:36px;
      border-radius:8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:white;
    }

    /* Dropdown menu */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background: linear-gradient(180deg, var(--panel), var(--card));
      min-width: 200px;
      box-shadow: var(--shadow);
      padding: 8px 0;
      z-index: 1000;
      border-radius: 8px;
      border: 1px solid var(--slot-border);
      backdrop-filter: blur(10px);
      top: 100%;
      left: 0;
      margin-top: 8px;
    }
    .dropdown-content.show {
      display: block;
    }
    .dropdown-item {
      color: var(--muted);
      padding: 10px 16px;
      text-decoration: none;
      display: block;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 13px;
    }
    .dropdown-item:hover {
      background: var(--glass);
      color: var(--accent);
    }

    /* College area */
    .college-select{
      display:flex;
      gap:8px;
      align-items:center;
      background: var(--glass);
      padding:8px;
      border-radius:10px;
      border:1px solid var(--slot-border);
    }
    select{
      background:transparent;
      color: var(--muted);
      border:none;
      padding:8px;
      font-size:14px;
      outline:none;
    }
    input[type="text"]{
      background:transparent;
      border:1px dashed var(--slot-border);
      color: var(--muted);
      padding:8px 10px;
      border-radius:8px;
      width:210px;
      font-size:13px;
    }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:22px auto;
      padding:0 20px 40px;
    }
    .panel{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.005));
      border-radius:12px;
      padding:18px;
      box-shadow: var(--shadow);
      border:1px solid var(--slot-border);
      transition: all 0.3s ease;
    }

    /* Time tabs */
    .time-tabs{
      display:flex;
      gap:8px;
      padding:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 12px;
      background:transparent;
      border-radius:8px;
      border:1px solid var(--slot-border);
      cursor:pointer;
      color: var(--muted);
      font-weight:600;
      font-size:13px;
      transition: all 0.2s;
    }
    .tab:hover{
      background: var(--glass);
    }
    .tab.active{
      background: linear-gradient(90deg, var(--accent), rgba(255,255,255,0.1));
      color:white;
      box-shadow: 0 8px 26px rgba(0,0,0,0.2);
      border:none;
    }

    /* Timetable grid */
    .grid-wrap{
      overflow:auto;
      border-radius:10px;
      padding:12px;
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.005));
      border:1px solid var(--slot-border);
    }
    table.timetable{
      border-collapse:collapse;
      width:100%;
      min-width:820px;
      table-layout: fixed;
      color: var(--muted);
    }
    .t-head th{
      text-align:left;
      padding:14px;
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.005));
      border-bottom:1px solid var(--slot-border);
      font-weight:700;
      font-size:13px;
      color: var(--accent);
      position:relative;
    }
    .t-head th .time-label{
      font-weight:700;
      color: var(--accent);
      font-size:14px;
    }
    tr{
      border-bottom:1px solid var(--slot-border);
    }
    td.tcell{
      height:92px;
      vertical-align:top;
      padding:10px;
      border-right:1px solid var(--slot-border);
      position:relative;
      background:transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    td.tcell:hover{
      background: var(--glass);
    }
    td.tcell .cell-inner{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* Session cards */
    .session{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:8px;
      color:white;
      font-weight:600;
      font-size:13px;
      cursor:grab;
      user-select:none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.1);
      transition: all 0.2s;
    }
    .session:hover{
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .session:active{ cursor:grabbing; }
    .session .dot{
      width:10px;height:10px;border-radius:50%;
      flex:0 0 auto;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }

    /* Drop indicator */
    .tcell.drop-target{
      outline: 2px dashed var(--accent);
      outline-offset: -6px;
      border-radius:8px;
      background: var(--glass);
    }

    .hint{
      color: var(--muted);
      padding:18px;
      text-align:center;
      font-size:14px;
    }
    .footer-note{
      margin-top:12px;color: var(--muted);font-size:13px;
    }

    /* Ghost */
    .ghost{
      position:fixed;
      pointer-events:none;
      z-index:1000;
      transform:translate(-50%,-50%);
      opacity:0.98;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: linear-gradient(180deg, var(--panel), var(--card));
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--slot-border);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--slot-border);
    }
    .modal-header h2 {
      margin: 0;
      color: var(--accent);
      font-size: 18px;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      color: var(--accent);
    }
    .modal-body {
      color: var(--muted);
      line-height: 1.6;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-option:hover {
      color: var(--accent);
    }
    .theme-swatch {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 2px solid var(--muted);
    }

    /* small responsive tweaks */
    @media (max-width:880px){
      .wrap{ padding:0 12px; }
      input[type="text"]{ width:140px; }
      table.timetable{ min-width:720px; }
      .header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="left-actions">
      <div class="brand">
        <div class="logo">T</div>
        Timetable
      </div>
      <div class="dropdown">
        <button class="btn" id="open-menu-btn">‚ò∞ Menu ‚ñº</button>
        <div class="dropdown-content" id="menuDropdown">
          <button class="dropdown-item" onclick="showModal('themeModal')">üé® Themes</button>
          <button class="dropdown-item" onclick="showModal('aboutModal')">‚ÑπÔ∏è About</button>
          <button class="dropdown-item" onclick="exportData()">üíæ Export Data</button>
          <button class="dropdown-item" onclick="importData()">üìÇ Import Data</button>
          <button class="dropdown-item" onclick="clearAllData()">üóëÔ∏è Clear All</button>
        </div>
      </div>
      <div class="dropdown">
        <button class="btn" id="semester-btn">üìÖ Semester ‚ñº</button>
        <div class="dropdown-content" id="semesterDropdown">
          <button class="dropdown-item" onclick="showModal('semesterModal')">Manage Semesters</button>
          <button class="dropdown-item">Semester 1 2025</button>
          <button class="dropdown-item">Semester 2 2025</button>
        </div>
      </div>
      <div class="dropdown">
        <button class="btn" id="view-btn">üëÅÔ∏è View ‚ñº</button>
        <div class="dropdown-content" id="viewDropdown">
          <button class="dropdown-item" onclick="setView('timetable')">üìä Timetable</button>
          <button class="dropdown-item" onclick="setView('summary')">üìã Summary</button>
          <button class="dropdown-item" onclick="setView('print')">üñ®Ô∏è Print View</button>
        </div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:12px;">
      <div class="college-select">
        <label style="font-size:12px;color:var(--muted);margin-right:8px;">College</label>
        <select id="collegeSelect" aria-label="Select college">
          <option value="">-- No colleges --</option>
        </select>
        <input type="text" id="collegeName" placeholder="Add college..." />
        <button class="btn primary" id="addCollegeBtn">+ Add</button>
      </div>
    </div>

    <div class="right-actions">
      <button class="btn" id="downloadBtn">üì• Download PDF</button>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="time-tabs" id="timeTabs" aria-hidden="false">
        <!-- tabs will be populated -->
      </div>

      <div class="grid-wrap panel" style="margin-top:6px;">
        <div id="noCollegeMessage" class="hint" style="display:block;">
          No college selected. Add a college to begin.
          <div class="footer-note">Double-click any cell to add a session. Drag sessions between cells.</div>
        </div>

        <div id="timetableArea" style="display:none;">
          <div style="overflow:auto;">
            <table class="timetable" id="timetable">
              <thead class="t-head">
                <tr id="headRow">
                  <th style="width:120px;">Day / Time</th>
                  <!-- time headers injected -->
                </tr>
              </thead>
              <tbody id="tableBody">
                <!-- rows injected -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div class="modal" id="themeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Choose Theme</h2>
        <button class="modal-close" onclick="closeModal('themeModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="theme-option" onclick="setTheme('default')">
          <div class="theme-swatch" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);"></div>
          <span>Modern (Default)</span>
        </div>
        <div class="theme-option" onclick="setTheme('tafe')">
          <div class="theme-swatch" style="background: linear-gradient(135deg, #0052a3, #1b7a7e);"></div>
          <span>TAFE NSW - Official</span>
        </div>
        <div class="theme-option" onclick="setTheme('picnic')">
          <div class="theme-swatch" style="background: linear-gradient(135deg, #d4845c, #6b8e23);"></div>
          <span>Sunday Picnic - Warm & Earthy</span>
        </div>
        <div class="theme-option" onclick="setTheme('ocean')">
          <div class="theme-swatch" style="background: linear-gradient(135deg, #1f7bbf, #2ce5b7);"></div>
          <span>Ocean Breeze - Calm & Fresh</span>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="aboutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>About Timetable</h2>
        <button class="modal-close" onclick="closeModal('aboutModal')">√ó</button>
      </div>
      <div class="modal-body">
        <p><strong>Interactive Timetabling App</strong></p>
        <p>A modern, multi-college timetable management system with drag-and-drop support.</p>
        <p><strong>Features:</strong></p>
        <ul>
          <li>Add unlimited colleges</li>
          <li>Create sessions by double-clicking cells</li>
          <li>Drag sessions between time slots</li>
          <li>Export/import your data</li>
          <li>Download as PDF</li>
          <li>Multiple color themes</li>
        </ul>
        <p><strong>Tips:</strong></p>
        <ul>
          <li>Double-click a cell to create a session</li>
          <li>Right-click a session to rename or delete</li>
          <li>Drag sessions to move them</li>
          <li>Use the time tabs to navigate</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="modal" id="semesterModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Manage Semesters</h2>
        <button class="modal-close" onclick="closeModal('semesterModal')">√ó</button>
      </div>
      <div class="modal-body">
        <p>Semester management coming soon!</p>
        <p>Currently using: <strong>Semester 1 2025</strong></p>
      </div>
    </div>
  </div>

  <script>
    // Theme management
    function setTheme(theme) {
      document.body.className = theme === 'default' ? '' : 'theme-' + theme;
      localStorage.setItem('timetable_theme', theme);
      closeModal('themeModal');
    }

    function loadTheme() {
      const theme = localStorage.getItem('timetable_theme') || 'default';
      if (theme !== 'default') {
        document.body.className = 'theme-' + theme;
      }
    }

    // Modal functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('show');
      closeAllDropdowns();
    }
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }
    function closeAllDropdowns() {
      document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show'));
    }

    // Data export/import
    function exportData() {
      const data = localStorage.getItem('timetable_colleges');
      const dataStr = data || '{}';
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'timetable-backup-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      alert('‚úÖ Data exported successfully!');
      closeAllDropdowns();
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            localStorage.setItem('timetable_colleges', JSON.stringify(data));
            alert('‚úÖ Data imported successfully!');
            location.reload();
          } catch (err) {
            alert('‚ùå Error importing data: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
      closeAllDropdowns();
    }

    function clearAllData() {
      if (confirm('‚ö†Ô∏è This will delete all colleges and sessions. Are you sure?')) {
        localStorage.removeItem('timetable_colleges');
        alert('‚úÖ All data cleared!');
        location.reload();
      }
      closeAllDropdowns();
    }

    function setView(view) {
      alert('View: ' + view + ' (coming soon)');
      closeAllDropdowns();
    }

    // Dropdown toggle
    document.getElementById('open-menu-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('menuDropdown').classList.toggle('show');
      document.getElementById('semesterDropdown').classList.remove('show');
      document.getElementById('viewDropdown').classList.remove('show');
    });

    document.getElementById('semester-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('semesterDropdown').classList.toggle('show');
      document.getElementById('menuDropdown').classList.remove('show');
      document.getElementById('viewDropdown').classList.remove('show');
    });

    document.getElementById('view-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('viewDropdown').classList.toggle('show');
      document.getElementById('menuDropdown').classList.remove('show');
      document.getElementById('semesterDropdown').classList.remove('show');
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', closeAllDropdowns);

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });

    (function(){
      // Config
      const TIMES = ["08:00","09:00","11:00","13:00","14:00","16:00"];
      const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday"];

      // Data: colleges stored in localStorage under key 'timetable_colleges'
      let colleges = loadColleges();
      let activeCollegeId = null;
      let activeTime = null;

      // DOM
      const collegeSelect = document.getElementById('collegeSelect');
      const addCollegeBtn = document.getElementById('addCollegeBtn');
      const collegeNameInput = document.getElementById('collegeName');
      const noCollegeMessage = document.getElementById('noCollegeMessage');
      const timetableArea = document.getElementById('timetableArea');
      const timetable = document.getElementById('timetable');
      const headRow = document.getElementById('headRow');
      const tableBody = document.getElementById('tableBody');
      const timeTabs = document.getElementById('timeTabs');
      const downloadBtn = document.getElementById('downloadBtn');

      // Drag state
      let dragging = null;
      let ghost = null;
      let currentDropCell = null;

      // Initialization
      loadTheme();
      buildTimeTabs();
      buildTableSkeleton();
      refreshCollegeSelect();

      // Event listeners
      addCollegeBtn.addEventListener('click', (e)=> {
        const name = collegeNameInput.value.trim();
        if(!name) return alert('Enter a college name.');
        createCollege(name);
        collegeNameInput.value = '';
      });

      collegeSelect.addEventListener('change', (e)=>{
        const id = collegeSelect.value;
        if(!id){
          activeCollegeId = null;
          renderNoCollege();
        } else {
          activeCollegeId = id;
          renderCollege();
        }
      });

      downloadBtn.addEventListener('click', (e)=>{
        window.print();
      });

      // Build tabs
      function buildTimeTabs(){
        timeTabs.innerHTML = '';
        TIMES.forEach(t=>{
          const btn = document.createElement('button');
          btn.className = 'tab';
          btn.textContent = t;
          btn.dataset.time = t;
          btn.addEventListener('click', ()=>{
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            btn.classList.add('active');
            activeTime = t;
            highlightTimeColumn(t);
          });
          timeTabs.appendChild(btn);
        });
      }

      // Highlight a time column
      function highlightTimeColumn(time){
        document.querySelectorAll('.t-head th').forEach(th=>{
          th.style.boxShadow = '';
          th.style.background = '';
        });
        const headers = Array.from(document.querySelectorAll('.t-head th'));
        const idx = TIMES.indexOf(time);
        if(idx >= 0){
          const th = headers[idx+1];
          if(th){
            th.style.background = 'linear-gradient(90deg, rgba(79,70,229,0.12), rgba(16,185,129,0.04))';
            th.style.boxShadow = 'inset 0 -6px 20px rgba(79,70,229,0.04)';
          }
        }
      }

      // Build table skeleton
      function buildTableSkeleton(){
        headRow.innerHTML = '';
        const first = document.createElement('th');
        first.textContent = 'Day / Time';
        first.style.width = '120px';
        headRow.appendChild(first);

        TIMES.forEach(t=>{
          const th = document.createElement('th');
          th.innerHTML = '<div class="time-label">' + t + '</div>';
          headRow.appendChild(th);
        });

        tableBody.innerHTML = '';
        DAYS.forEach(d=>{
          const tr = document.createElement('tr');
          const dayTh = document.createElement('th');
          dayTh.textContent = d;
          dayTh.style.fontWeight = '700';
          dayTh.style.fontSize = '13px';
          dayTh.style.color = 'var(--muted)';
          dayTh.style.padding = '14px';
          tr.appendChild(dayTh);

          TIMES.forEach(t=>{
            const td = document.createElement('td');
            td.className = 'tcell empty';
            const key = cellKey(d,t);
            td.dataset.key = key;
            td.addEventListener('dblclick', cellDoubleClick);
            td.tabIndex = 0;
            td.addEventListener('keydown', (ev)=>{
              if(ev.key === 'Enter'){
                cellDoubleClick.call(td, ev);
              }
            });
            const inner = document.createElement('div');
            inner.className = 'cell-inner';
            td.appendChild(inner);
            tr.appendChild(td);
          });

          tableBody.appendChild(tr);
        });
      }

      function cellKey(day, time){
        return day + '|' + time;
      }

      // Colleges storage utilities
      function loadColleges(){
        try{
          const raw = localStorage.getItem('timetable_colleges');
          return raw ? JSON.parse(raw) : {};
        } catch(e){
          return {};
        }
      }
      function saveColleges(){
        localStorage.setItem('timetable_colleges', JSON.stringify(colleges));
      }

      function createCollege(name){
        const id = 'c_' + Date.now();
        colleges[id] = {
          id,
          name,
          sessions: {}
        };
        saveColleges();
        refreshCollegeSelect();
        collegeSelect.value = id;
        activeCollegeId = id;
        renderCollege();
      }

      function refreshCollegeSelect(){
        const prev = collegeSelect.value;
        collegeSelect.innerHTML = '';
        const optDefault = document.createElement('option');
        optDefault.value = '';
        optDefault.textContent = '-- No colleges --';
        collegeSelect.appendChild(optDefault);

        Object.values(colleges).forEach(c=>{
          const o = document.createElement('option');
          o.value = c.id;
          o.textContent = c.name;
          collegeSelect.appendChild(o);
        });

        if(prev && colleges[prev]) collegeSelect.value = prev;
      }

      function renderNoCollege(){
        noCollegeMessage.style.display = 'block';
        timetableArea.style.display = 'none';
      }

      function renderCollege(){
        if(!activeCollegeId || !colleges[activeCollegeId]){
          renderNoCollege();
          return;
        }
        noCollegeMessage.style.display = 'none';
        timetableArea.style.display = 'block';
        document.querySelectorAll('.tcell .cell-inner').forEach(inner => inner.innerHTML = '');
        const col = colleges[activeCollegeId];
        for(const key in col.sessions){
          const arr = col.sessions[key];
          arr.forEach(s => {
            const cell = document.querySelector('.tcell[data-key="'+escapeSelector(key)+'"] .cell-inner');
            if(cell) cell.appendChild(renderSessionElement(s));
          });
        }
      }

      function escapeSelector(s){
        return s.replace(/"/g,'\\"').replace(/'/g,"\\'");
      }

      // Create session element DOM
      function renderSessionElement(session){
        const el = document.createElement('div');
        el.className = 'session';
        el.dataset.id = session.id;
        el.dataset.title = session.title;
        el.style.background = session.color || 'linear-gradient(90deg, #4f46e5, #7c3aed)';
        el.style.borderColor = 'rgba(255,255,255,0.04)';
        const dot = document.createElement('span');
        dot.className = 'dot';
        dot.style.background = session.color ? session.color : '#3b82f6';
        dot.style.minWidth = '10px';
        dot.style.minHeight = '10px';
        el.appendChild(dot);
        const span = document.createElement('span');
        span.textContent = session.title;
        el.appendChild(span);

        el.addEventListener('pointerdown', sessionPointerDown);
        el.addEventListener('dragstart', e => e.preventDefault());

        return el;
      }

      // Double-click to create session
      function cellDoubleClick(e){
        const td = e.currentTarget || this;
        if(!activeCollegeId){
          alert('Please add and select a college first.');
          return;
        }
        const title = prompt('Session title:','New Session');
        if(!title) return;
        const color = prompt('Session color (hex or css color) or leave blank for default:','#4f46e5') || '#4f46e5';
        const session = {
          id: 's_' + Date.now(),
          title: title,
          color: color
        };
        const key = td.dataset.key;
        const col = colleges[activeCollegeId];
        if(!col.sessions[key]) col.sessions[key] = [];
        col.sessions[key].push(session);
        saveColleges();
        const inner = td.querySelector('.cell-inner');
        inner.appendChild(renderSessionElement(session));
      }

      // Session dragging
      function sessionPointerDown(ev){
        ev.preventDefault();
        const target = ev.currentTarget;
        const sessionId = target.dataset.id;
        const title = target.dataset.title || '';
        let originCell = target.closest('.tcell');
        const originKey = originCell ? originCell.dataset.key : null;

        dragging = {
          elem: target,
          sessionId,
          title,
          originKey
        };

        ghost = target.cloneNode(true);
        ghost.classList.add('ghost');
        ghost.style.width = target.offsetWidth + 'px';
        ghost.style.height = target.offsetHeight + 'px';
        document.body.appendChild(ghost);

        target.setPointerCapture(ev.pointerId);
        moveGhost(ev.pageX, ev.pageY);

        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);

        target.style.opacity = '0.16';
        target.style.transform = 'scale(0.98)';
      }

      function moveGhost(pageX, pageY){
        if(!ghost) return;
        ghost.style.left = pageX + 'px';
        ghost.style.top = pageY + 'px';
      }

      function onPointerMove(ev){
        moveGhost(ev.pageX, ev.pageY);
        const el = document.elementFromPoint(ev.clientX, ev.clientY);
        const cell = el ? el.closest('.tcell') : null;

        if(cell && cell !== currentDropCell){
          if(currentDropCell) currentDropCell.classList.remove('drop-target');
          currentDropCell = cell;
          currentDropCell.classList.add('drop-target');
        } else if(!cell && currentDropCell){
          currentDropCell.classList.remove('drop-target');
          currentDropCell = null;
        }
      }

      function onPointerUp(ev){
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);

        if(ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        if(dragging && dragging.elem) {
          dragging.elem.style.opacity = '';
          dragging.elem.style.transform = '';
        }

        if(currentDropCell){
          const destKey = currentDropCell.dataset.key;
          if(dragging && dragging.originKey){
            const col = colleges[activeCollegeId];
            if(col){
              const originArr = col.sessions[dragging.originKey] || [];
              const idx = originArr.findIndex(s => s.id === dragging.sessionId);
              let sessionObj = null;
              if(idx >= 0){
                sessionObj = originArr.splice(idx,1)[0];
                if(originArr.length === 0) delete col.sessions[dragging.originKey];
              } else {
                sessionObj = {id:dragging.sessionId, title:dragging.title, color:dragging.elem.style.background};
              }
              if(!col.sessions[destKey]) col.sessions[destKey] = [];
              col.sessions[destKey].push(sessionObj);
              saveColleges();
            }
          }

          const inner = currentDropCell.querySelector('.cell-inner');
          if(inner && dragging && dragging.elem){
            inner.appendChild(dragging.elem);
          }
        }

        if(currentDropCell) currentDropCell.classList.remove('drop-target');
        currentDropCell = null;
        dragging = null;
        ghost = null;
      }

      if(Object.keys(colleges).length === 0){
        renderNoCollege();
      } else {
        const firstId = Object.keys(colleges)[0];
        collegeSelect.value = firstId;
        activeCollegeId = firstId;
        renderCollege();
      }

      document.addEventListener('contextmenu', function(e){
        const ses = e.target.closest('.session');
        if(ses){
          e.preventDefault();
          const id = ses.dataset.id;
          const action = prompt('Enter "delete" to remove, or new title to rename:', 'delete');
          if(!action) return;
          if(action.toLowerCase() === 'delete'){
            if(!activeCollegeId) return;
            const col = colleges[activeCollegeId];
            for(const key in col.sessions){
              const arr = col.sessions[key];
              const idx = arr.findIndex(s => s.id === id);
              if(idx >= 0){
                arr.splice(idx,1);
                if(arr.length === 0) delete col.sessions[key];
                saveColleges();
                ses.remove();
                break;
              }
            }
          } else {
            const newTitle = action;
            ses.querySelector('span:last-child').textContent = newTitle;
            if(!activeCollegeId) return;
            const col = colleges[activeCollegeId];
            for(const key in col.sessions){
              const arr = col.sessions[key];
              const s = arr.find(s => s.id === id);
              if(s){ s.title = newTitle; saveColleges(); break; }
            }
          }
        }
      });
    })();
  </script>
</body>
</html>